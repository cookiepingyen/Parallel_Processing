# 平行處理

## 平行處理資料載入/寫入速度

## 硬體規格
### CPU AMD 3750H  |  P-Core:4 E-Core:0 Threads:8
### RAM 16GB


### 實驗0
#### 實驗0-1 初始時間(讀取+寫入)：

| 筆數 | 讀取秒數(s) | 寫入秒數(s) | 總共耗時(s) | 記憶體用量(mb) |
|------|------|------|------|------------|
| 1,000 | 0.023 | | 1.332 | 13 |
| 5,000 | 0.051 | | 3.738 |
| 10,000 | 0.088 | | 6.141 |
| 50,000 | 0.287 | | 25.998 |
| 100,000 | 0.703 | | 51.254 |
| 200,000 | 1.644 | | 99.917 |
| 500,000 | 3.104 | | 240.763 |
| 1,000,000 | 5.85 | | 550.215 |
| 2,000,000 | 10.04 | | |
| 3,000,000 | 14.421 | | |
| 5,000,000 | 23.784 | | |
| 10,000,000 | 57.193 | | |

#### 實驗0-2 優化StreamWriter 循序寫入後(讀取+寫入)：

| 筆數 | 讀取秒數(s) | 寫入秒數(s) | 總共耗時(s) | 記憶體用量(mb) |
|------|------|------|------|------------|
| 1,000 | 0.046 | 0.009 | 0.055 | 11 |
| 5,000 | 0.066 | 0.022 | 0.088 | 14 |
| 10,000 | 0.088 | 0.05 | 0.139 | 17 |
| 50,000 | 0.653 | 0.286 | 0.939 | 26 |
| 100,000 | 0.999 | 0.566 | 1.565 | 40 |
| 200,000 | 1.877 | 0.459 | 2.336 | 64 |
| 500,000 | 3.904 | 1.19 | 5.094 | 133 |
| 1,000,000 | 6.32 | 2.111 | 8.431 | 253 |
| 2,000,000 | 13.514 | 4.724 | 18.238 | 488 |
| 3,000,000 | 16.612 | 7.62 | 24.232 | 725 |
| 5,000,000 | 27.722 | 13.137 | 40.859 | 1.2G |
| 10,000,000 | 67.777 | 62.346 | 130.123 | 2.3G |
| 12,000,000 | 79.637 | 57.855 | 137.492 | 2.8G |
| 24,000,000 | out_of_memory |  |  |  |
| 30,000,000 |  |  |  |  |
| 40,000,000 |  |  |  |  |


### 實驗1 分批讀取
* 每次批次都要清除記憶體
#### 1-1 每100萬為一批次
| 筆數 | 讀取秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 5,000,000 | 19.64 |  |
| 10,000,000 | 39.37 | - |

#### 1-2 每150萬為一批次
| 筆數 | 讀取秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 5,000,000 | 19.71 |  |
| 10,000,000 | 41.24 | - |

#### 1-3 每200萬為一批次
| 筆數 | 讀取秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 5,000,000 | 21.62 |  |
| 10,000,000 | 37.47 | - |

#### 1-4 每250萬為一批次
| 筆數 | 讀取秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 5,000,000 | 21.48 |  |
| 10,000,000 | 37.6 | - |

#### 1-5 每300萬為一批次
| 筆數 | 讀取秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 5,000,000 | 23.45 |  |
| 10,000,000 | 39.08 | - |

#### 1-6 每350萬為一批次
| 筆數 | 讀取秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 5,000,000 | 24.35 |  |
| 10,000,000 | 43.12 | - |

#### 1-7 每400萬為一批次
| 筆數 | 讀取秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 5,000,000 | 27.04 |  |
| 10,000,000 | 50.03 | - |

### 實驗2 分批讀取 + 批次寫入
#### 2-1 每100萬筆一次
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|
| 5,000,000 | 14.95 | 4.23 | 19.62 | 1200 |
| 10,000,000 | 26.92 | 8.09 | 45.48 | 1700 |

#### 2-2 每150萬筆一次
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|
| 5,000,000 | 16.375 | 6.685 | 25.66 | 1100 |
| 10,000,000 | 34.02 | 12.7 | 48.13 | 2200 |

#### 2-3 每200萬筆一次
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|
| 5,000,000 | 16.68 | 7.33 | 24.9 | 1100 |
| 10,000,000 | 31.63 | 14.75 | 49.42 | 2300 |

#### 2-4 每250萬筆一次
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|
| 5,000,000 | 18.595 | 6.695 | 25.51 | 1200 |
| 10,000,000 | 35.43 | 17.13 | 53.79 | 2200 |

#### 2-5 每300萬筆一次
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|
| 5,000,000 | 17.725 | 6.575 | 26.4 | 1100 |
| 10,000,000 | 39.325 | 10.515 | 52.66 | 2200 |

#### 2-6 每350萬筆一次
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|
| 5,000,000 | 16.76 | 6.665 | 28.49 | 1100 |
| 10,000,000 | 36.35 | 19.13 | 59.15 | 2300 |

#### 2-7 每400萬筆一次
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|
| 5,000,000 | 16.955 | 6.705 | 32.92 | 1007 |
| 10,000,000 | 35.27 | 13.3 | 54.09 | 2300 |

#### 每50000筆一次
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 10,000 |- | - |
| 50,000 | 0.918 | 21 |
| 100,000 | 2.428 | 20 |
| 150,000 | 3.887 | 21 |
| 200,000 | 4.099 | 21 |
| 500,000 | 9.954 | 21 |
| 1,000,000 | 38.197 | 21 |
| 5,000,000 | 520.18 | 21 |
| 10,000,000 | - | - |
#### 每50000筆一次 (GC)
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 10,000 |- | - |
| 50,000 | 1.142 | 30 |
| 100,000 | 1.497 | 41 |
| 150,000 | 2.992 | 46 |
| 200,000 | 4.686 | 51 |
| 500,000 | 7.435 | 63 |
| 1,000,000 | 12.957 | 66 |
| 5,000,000 | 158.046 | 65 |
| 10,000,000 | - | - |

#### 每50000筆一次 (固態硬碟＋GC)
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 10,000 |- | - |
| 50,000 | 1.235 | 30 |
| 100,000 | 2.294 | 41 |
| 150,000 | 2.968 | 47 |
| 200,000 | 3.632 | 65 |
| 500,000 | 6.999 | 65 |
| 1,000,000 | 12.79 | 65 |
| 5,000,000 | 158.046 | 65 |
| 10,000,000 | - | - |

#### 讀取 + 寫入 五條執行緒
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 10,000 | 0.099 | 15 |
| 50,000 | 0.248 | 22 |
| 100,000 | 0.389 | 15 |
| 150,000 | 0.49 | 15 |
| 200,000 | 0.506| 15 |
| 500,000 | 1.309 | 15 |
| 1,000,000 | 2.695 | 15 |
| 5,000,000 | 55 | 15 |
| 10,000,000 | 115.948 | 164 |




---
## 優化CSV讀取和寫入

### Split VS Span (只做切割，取得字串陣列) 只有split 沒有加上反射
| Method | Mean     | Error    | StdDev   | Gen0   | Allocated |
|------- |---------:|---------:|---------:|-------:|----------:|
| Split  | 441.5 ns | 13.64 ns | 39.56 ns | 1.0920 |     573 B |
| Span   | 391.3 ns |  1.99 ns |  1.66 ns | 0.4964 |     260 B |

### Split VS Span (只做切割，取得字串陣列) + 反射
| Method | Mean     | Error     | StdDev    | Gen0   | Allocated |
|------- |---------:|----------:|----------:|-------:|----------:|
| Split  | 2.295 us | 0.0580 us | 0.1700 us | 1.6861 |     885 B |
| Span   | 2.102 us | 0.0156 us | 0.0145 us | 1.0948 |     576 B |

### Split VS Span (只做切割，取得字串陣列) + 反射 + GetProperties 只做一次
| Method | Mean     | Error     | StdDev    | Gen0   | Allocated |
|------- |---------:|----------:|----------:|-------:|----------:|
| Split  | 2.337 us | 0.0592 us | 0.1744 us | 1.6861 |     885 B |
| Span   | 1.868 us | 0.0308 us | 0.0241 us | 1.0223 |     537 B |

### Split VS Span (只做切割，取得字串陣列) + 反射 + GetProperties 只做一次 + List 只建立一次
| Method | Mean     | Error     | StdDev    | Gen0   | Allocated |
|------- |---------:|----------:|----------:|-------:|----------:|
| Split  | 2.295 us | 0.0482 us | 0.1422 us | 1.6861 |     885 B |
| Span   | 1.880 us | 0.0328 us | 0.0291 us | 0.9232 |     485 B |


### Split VS Span (只做切割，取得字串陣列) + 反射 + GetProperties 只做一次 + List 只建立一次 + 反射SetValue 只做一次
| Method | Mean       | Error    | StdDev    | Gen0   | Allocated |
|------- |-----------:|---------:|----------:|-------:|----------:|
| Split  | 2,423.3 ns | 68.91 ns | 201.00 ns | 1.6861 |     885 B |
| Span   |   506.9 ns |  5.09 ns |   4.25 ns | 0.5569 |     292 B |

### Split VS Span (只做切割，取得字串陣列) + 反射 + GetProperties 只做一次 + List 只建立一次 + 反射SetValue 只做一次 + 拿掉string array
| Method | Mean       | Error    | StdDev    | Gen0   | Allocated |
|------- |-----------:|---------:|----------:|-------:|----------:|
| Split  | 2,324.5 ns | 56.12 ns | 161.01 ns | 1.6861 |     885 B |
| Span   |   471.8 ns |  4.02 ns |   3.14 ns | 0.4888 |     256 B |



### Write VS OptimazeWrite (只做組成單筆字串data) + 不做TrimEnd
| Method        | Mean     | Error     | StdDev    | Gen0   | Allocated |
|-------------- |---------:|----------:|----------:|-------:|----------:|
| Write         | 1.543 us | 0.0406 us | 0.1173 us | 0.5188 |     272 B |
| OptimazeWrite | 1.496 us | 0.0561 us | 0.1655 us | 0.4196 |     220 B |

### Write VS OptimazeWrite (只做組成單筆字串data) + 不做TrimEnd + 使用 StringBuilder
| Method        | Mean     | Error     | StdDev    | Gen0   | Allocated |
|-------------- |---------:|----------:|----------:|-------:|----------:|
| Write         | 1.672 us | 0.0592 us | 0.1649 us | 0.5188 |     272 B |
| OptimazeWrite | 1.240 us | 0.0242 us | 0.0322 us | 0.1297 |      68 B |

### Write VS OptimazeWrite (只做組成單筆字串data) + 不做TrimEnd + 使用 StringBuilder + GetProperties只做一次
| Method        | Mean     | Error     | StdDev    | Gen0   | Allocated |
|-------------- |---------:|----------:|----------:|-------:|----------:|
| Write         | 1.681 us | 0.0404 us | 0.1158 us | 0.8774 |     461 B |
| OptimazeWrite | 1.089 us | 0.0188 us | 0.0193 us | 0.2518 |     132 B |

### Write VS OptimazeWrite (只做組成單筆字串data) + 不做TrimEnd + ToString(0, stringBuilder.Length - 1) + 使用 StringBuilder + GetProperties只做一次 
| Method        | Mean     | Error     | StdDev    | Gen0   | Allocated |
|-------------- |---------:|----------:|----------:|-------:|----------:|
| Write         | 1.726 us | 0.0551 us | 0.1617 us | 0.8774 |     461 B |
| OptimazeWrite | 1.235 us | 0.0506 us | 0.1484 us | 0.2518 |     132 B |


### Write VS OptimazeWrite (只做組成單筆字串data) + 不做TrimEnd + ToString(0, stringBuilder.Length - 1) + 使用 StringBuilder + GetProperties只做一次 + 反射GetValue只做一次
| Method        | Mean       | Error    | StdDev    | Gen0   | Allocated |
|-------------- |-----------:|---------:|----------:|-------:|----------:|
| Write         | 1,873.8 ns | 55.74 ns | 164.34 ns | 0.8774 |     461 B |
| OptimazeWrite |   212.9 ns |  4.12 ns |   4.75 ns | 0.2518 |     132 B |


### Write VS OptimazeWrite 改成使用字串做寫入(單次100萬筆資料)
| Method        | Mean       | Error     | StdDev    | Gen0        | Allocated    |
|-------------- |-----------:|----------:|----------:|------------:|-------------:|
| Write         | 5,958.2 ms | 184.87 ms | 527.44 ms | 305000.0000 | 156499.23 KB |
| OptimazeWrite |   365.8 ms |  14.98 ms |  43.93 ms |           - |        16 KB |


### 結論

- 讀取優化 :
  1. GetProperties只做一次
  2. List 只建立一次
  3. 反射SetValue 只做一次
  4. 拿掉 string array


- 寫入優化 
  1. 不做TrimEnd
  2. 使用 StringBuilder
  3. GetProperties只做一次
  4. 判斷最後一次才加上',' 改成ToString(0, stringBuilder.Length - 1)
  5. 透過 StringBuilder.CopyTo() 寫到字元陣列，代替 .ToString()
  6. writer.WriteLine(chars, 0, stringBuilder.Length - 1);
  7. 全部資料寫完才執行writer.Flush();


## 優化後數據

### 實驗4 批次讀取+寫入


#### 4-1 每250萬筆一次
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|
| 5,000,000(舊) | 18.595 | 6.695 | 25.51 | 1200 |
| 5,000,000(新) | 11.03 | 6.445 | 18.84 | 1200 |
| 10,000,000(舊) | 35.43 | 17.13 | 53.79 | 2200 |
| 10,000,000(新) | 28.045 | 11.97 | 45.39 s | 2300 |
| 10,000,000(新-改) | 25.365 | 4.525 | 34.44 s | 2200 |
| 10,000,000(平行處理) | 21.69 | 2.885 | 28.6 s | 3000 |
| 12,000,000(新-改) | 25.25 | 4.96 | 37.49 | 2800 |
| 12,000,000(平行處理) | 22.9 | 4.87 | 31.45 s | 3000 |
| 24,000,000(新) | 56.14 | 7.42 | 82.17 | 2800 |
| 24,000,000(OptimizeRead) | 65.7 | 8.905 | 116.27 | 2800 |
| 24,000,000(Read) | 87.04 | 5.155 | 111.68 | 3500 |
| 24,000,000(平行處理) | 37.365 | 3.305 | 64.41 | 3900 |
| 30,000,000(新) | 73.705 | 14.645 | 123.07 | 3500 |
| 30,000,000(新-改) | 81.24 | 7.085 | 127.4 | 3500 |
| 30,000,000(平行處理) | 41.765 | 3.11 | 81.89 | 4300 |
| 40,000,000(新) | 83.39 | 18.755 | 168.04 | 3500 |
| 40,000,000(平行處理) | 44.19 | 4.12 | 114.93 | 4400 |
| 60,000,000(新) | 175.905 | 22.075 | 326.99 | 3500 |
| 80,000,000(新) | 224.75 | 27.615 | 477.42 | 3500 |


#### 4-2 每100萬筆一次
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|
| 10,000,000 | 20.775 | 3.765 | 34.83 s | 2300 |
| 12,000,000 | 22.07 | 3.16 | 41.78 s | 1800 |
| 24,000,000 | 37.335 | 3.815 | 105.22 s | 2200 |
| 30,000,000 | 44.065 | 4.53 | 160.02 s | 1600 |
| 40,000,000 | 60.605 | 4.64 | 251.48 s | 2200 |


#### 4-3 每300萬筆一次
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
| 24,000,000(新) | 62.35 | 7.12 | 94.42 | 3500 |



#### 4-4 每300萬筆一次(拆成每次寫入100萬)
| 筆數 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|
| 12,000,000 | 47.03 | 4.79 | 56.76 s | 2500 |
| 24,000,000 | 64.47 | 10.625 | 95.84 | 3500 |
| 30,000,000 | 87.42 | 16.435 | 138.48 | 3500 |
| 40,000,000 | 111.73 | 12.145 | 181.62 | 3500 |
| 60,000,000 | 144.68 | 8.615 | 295.68 | 3500 |



#### 4-5 平行處理

| 總筆數 | 每批數量 | 拆批寫入(100萬) | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |  記憶體用量(mb) |
|------|-----|----|-----|------|------|------|
| 10,000,000 | 250萬 | x | 21.69 | 2.885 | 28.6 s | 3000 |
| 24,000,000 | 250萬 | x | 37.365 | 3.305 | 64.41 | 3900 |
| 30,000,000 | 250萬 | x | 41.765 | 3.11 | 81.89 | 4300 |
| 40,000,000 | 250萬 | x | 44.19 | 4.12 | 114.93 | 4400 |
| 40,000,000 | 250萬 | O | 54.595 | 2.965 | 122 | 4800 |
| 40,000,000 | 300萬 | x | 51.955 | 4.785 | 105.82 | 4400 |
| 40,000,000 | 300萬 | O | 60.67 | 1.935 | 120.66 | 4400 |
| 60,000,000 | 300萬 | X | 140.11 | 1.994 | 392.45 | 4400 |
| 80,000,000 | 300萬 | X | 200.02 | 5.74 | 765.68 | 4400 |


#### 每一批次寫入總量速度
  50W:
  單檔案總寫入時間: 3.251s
  批次總寫入時間: 1.04s

  75W:
  單檔案總寫入時間: 3.183s
  批次總寫入時間: 1.249s

  100W:
  單檔案總寫入時間: 2.957s
  批次總寫入時間: 1.492s
  10W:
  單檔案總寫入時間: 2.988s
  批次總寫入時間: 1.321s


#### Lock 寫入速度比較
| Lock Type              | 總筆數      | 每批數量 | 平均讀取秒數(s) | 平均寫入秒數(s) | 總執行時間(s) |
|------------------------|------------|----------|------------------|------------------|----------------|
| Lock                   | 12,000,000 | 300萬    | 23.369           | 3.235            | 33.32          |
| Lock                   | 24,000,000 | 300萬    | 43.035           | 3.75             | 66.51          |
| Lock                   | 40,000,000 | 300萬    | 48.75            | 4.505            | 101.1          |
| Mutex                  | 12,000,000 | 300萬    | 18.09            | 4.57             | 26.03          |
| Mutex                  | 24,000,000 | 300萬    | 37.66            | 7.235            | 60.86          |
| ConcurrentBag          | 12,000,000 | 300萬    | -                | -                | 36.24          |
| ConcurrentBag          | 24,000,000 | 300萬    | -                | -                | 91.27          |
| ConcurrentQueue        | 12,000,000 | 300萬    | -                | -                | 33.72          |
| ConcurrentQueue        | 24,000,000 | 300萬    | -                | -                | 131.25         |
| ReaderWriterLockSlim   | 12,000,000 | 300萬    | 43.23            | 2.5              | 53.11          |
| ReaderWriterLockSlim   | 24,000,000 | 300萬    | 57.315           | 5.21             | 78.82          |
| SemaphoreSlim          | 12,000,000 | 300萬    | 24.66            | 4.5              | 33.41          |
| SemaphoreSlim          | 24,000,000 | 300萬    | 40.875           | 4.22             | 61.75          |
